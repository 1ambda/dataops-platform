# User Engagement Data Processing - Daily Click Aggregation
# DML query for data processing (no metrics - following 2025 best practices)
# Legacy spec.*.yaml format with type field for backward compatibility

# ─────────────────────────────────────────────
# REQUIRED FIELDS
# ─────────────────────────────────────────────
name: "iceberg.analytics.daily_clicks"
description: "Daily aggregation of user click events with engagement scoring and behavioral pattern analysis"
owner: "henrykim@example.com"
team: "@data-analytics"
type: "Dataset"
query_type: "DML"

# ─────────────────────────────────────────────
# OPTIONAL FIELDS - Metadata & Organization
# ─────────────────────────────────────────────
domains:
  - "feed"
  - "engagement"
  - "user-behavior"
tags:
  - "daily"
  - "kpi"
  - "aggregation"
  - "user-analytics"

# ─────────────────────────────────────────────
# VERSION HISTORY - Data Processing Evolution
# ─────────────────────────────────────────────
versions:
  - version: "v1"
    started_at: "2015-12-01"
    ended_at: "2022-05-31"
    description: "Initial version with basic click counts and simple aggregations"
  - version: "v2"
    started_at: "2022-06-01"
    ended_at: "2024-12-31"
    description: "Enhanced with window functions and session tracking"
  - version: "v3"
    started_at: "2025-01-01"
    description: "Advanced behavioral scoring with ML-based engagement metrics and real-time processing optimization"

# ─────────────────────────────────────────────
# PARAMETERS - Processing Configuration
# ─────────────────────────────────────────────
parameters:
  - name: "execution_date"
    type: "date"
    required: true
    description: "Date to process user click events for (YYYY-MM-DD)"
  - name: "lookback_days"
    type: "integer"
    required: false
    default: 7
    description: "Number of days to look back for session context and behavioral patterns"
  - name: "min_session_duration"
    type: "integer"
    required: false
    default: 30
    description: "Minimum session duration in seconds to include in processing"
  - name: "engagement_threshold"
    type: "float"
    required: false
    default: 0.5
    description: "Engagement score threshold for high-quality interactions"

# ─────────────────────────────────────────────
# SQL DEFINITION
# ─────────────────────────────────────────────
query_file: "daily_clicks.sql"

# ─────────────────────────────────────────────
# PRE-PROCESSING STEPS
# ─────────────────────────────────────────────
pre_statements:
  - name: "delete_partition"
    sql: |
      DELETE FROM iceberg.analytics.daily_clicks
      WHERE dt = '{{ execution_date }}'

# ─────────────────────────────────────────────
# POST-PROCESSING STEPS
# ─────────────────────────────────────────────
post_statements:
  - name: "optimize"
    sql: |
      ALTER TABLE iceberg.analytics.daily_clicks
      EXECUTE optimize WHERE dt = '{{ execution_date }}'
    continue_on_error: true

# ─────────────────────────────────────────────
# DEPENDENCIES & DATA LINEAGE
# ─────────────────────────────────────────────
depends_on:
  - "iceberg.raw.user_events"

# ─────────────────────────────────────────────
# EXECUTION CONFIGURATION
# ─────────────────────────────────────────────
execution:
  timeout_seconds: 1800  # 30 minutes for large-scale processing
  retry_count: 3
  retry_delay_seconds: 60
  dialect: "trino"
