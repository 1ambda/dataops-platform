# User Engagement Metrics - Analytics Dashboard
# type: Metric -> query_type: SELECT (read-only analytical queries)

# Required fields
name: "iceberg.analytics.user_engagement"
description: "User engagement metrics for analytics dashboard with behavioral insights"
owner: "analyst@example.com"
team: "@data-analytics"
type: "Metric"
query_type: "SELECT"

# Metadata
domains:
  - "analytics"
  - "engagement"
  - "user-behavior"
tags:
  - "metric"
  - "kpi"
  - "dashboard"

# Version history
versions:
  - version: "v1"
    started_at: "2024-01-01"
    description: "Initial metric definitions for user engagement"

# Query parameters
parameters:
  - name: "start_date"
    type: "date"
    required: true
    description: "Start date for the analysis period"
  - name: "end_date"
    type: "date"
    required: true
    description: "End date for the analysis period"
  - name: "min_sessions"
    type: "integer"
    required: false
    default: 1
    description: "Minimum number of sessions to include user"

# SQL definition
query_file: "user_engagement.sql"

# Dependencies
depends_on:
  - "iceberg.raw.user_events"
  - "iceberg.dim.users"

# Output schema
schema:
  - name: "user_id"
    type: "string"
  - name: "session_count"
    type: "integer"
  - name: "total_duration_ms"
    type: "bigint"
  - name: "avg_session_duration_ms"
    type: "float"
  - name: "country_code"
    type: "string"
  - name: "last_activity_date"
    type: "date"

# Semantic Layer - Metric Definitions (dbt MetricFlow compatible)
metrics:
  - name: "active_users"
    aggregation: "count_distinct"
    expression: "user_id"
    description: "Number of unique active users"
    filters:
      - "session_count >= {{ min_sessions }}"

  - name: "total_sessions"
    aggregation: "sum"
    expression: "session_count"
    description: "Total number of user sessions"

  - name: "avg_session_duration"
    aggregation: "avg"
    expression: "avg_session_duration_ms"
    description: "Average session duration across all users"
    filters:
      - "avg_session_duration_ms > 0"

  - name: "max_session_duration"
    aggregation: "max"
    expression: "total_duration_ms"
    description: "Maximum total session duration"

  - name: "engagement_score"
    aggregation: "avg"
    expression: "CASE WHEN session_count >= 10 THEN 1.0 WHEN session_count >= 5 THEN 0.7 ELSE 0.3 END"
    description: "Average engagement score based on session frequency"

# Semantic Layer - Dimension Definitions
dimensions:
  - name: "user_country"
    type: "categorical"
    expression: "country_code"
    description: "User's country of origin"

  - name: "activity_date"
    type: "time"
    expression: "last_activity_date"
    description: "Date of last user activity"

  - name: "engagement_tier"
    type: "categorical"
    expression: "CASE
      WHEN session_count >= 20 THEN 'power_user'
      WHEN session_count >= 10 THEN 'active'
      WHEN session_count >= 5 THEN 'regular'
      ELSE 'casual'
    END"
    description: "User engagement tier classification"

# Execution configuration
execution:
  timeout_seconds: 300
  dialect: "trino"
