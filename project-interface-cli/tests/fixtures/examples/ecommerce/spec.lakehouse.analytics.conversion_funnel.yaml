# E-commerce Analytics - Conversion Funnel Analysis
# SELECT query with metrics following dbt MetricFlow patterns

name: "lakehouse.analytics.conversion_funnel"
description: "E-commerce conversion funnel analysis with stage-by-stage metrics"
owner: "analytics-team@ecommerce.com"
team: "@growth-analytics"

domains:
  - "ecommerce"
  - "conversion"
  - "growth"
tags:
  - "funnel"
  - "conversion"
  - "kpi"
  - "daily"

query_type: "SELECT"

parameters:
  - name: "analysis_date"
    type: "date"
    required: true
    description: "Date for funnel analysis"
  - name: "cohort_days"
    type: "integer"
    required: false
    default: 30
    description: "Number of days for cohort analysis"
  - name: "min_session_duration"
    type: "integer"
    required: false
    default: 30
    description: "Minimum session duration in seconds"

query_statement: |
  WITH funnel_stages AS (
    SELECT
      '{{ analysis_date }}' as analysis_date,
      user_id,
      session_id,
      CASE
        WHEN page_views >= 1 THEN 1 ELSE 0
      END as visited,
      CASE
        WHEN product_views >= 1 THEN 1 ELSE 0
      END as viewed_product,
      CASE
        WHEN cart_adds >= 1 THEN 1 ELSE 0
      END as added_to_cart,
      CASE
        WHEN purchases >= 1 THEN 1 ELSE 0
      END as purchased,
      session_duration_seconds,
      total_revenue
    FROM lakehouse.staging.session_events
    WHERE dt = '{{ analysis_date }}'
      AND session_duration_seconds >= {{ min_session_duration }}
  )
  SELECT *
  FROM funnel_stages

depends_on:
  - "lakehouse.staging.session_events"

schema:
  - name: "analysis_date"
    type: "date"
  - name: "user_id"
    type: "string"
  - name: "session_id"
    type: "string"
  - name: "visited"
    type: "integer"
  - name: "viewed_product"
    type: "integer"
  - name: "added_to_cart"
    type: "integer"
  - name: "purchased"
    type: "integer"
  - name: "session_duration_seconds"
    type: "integer"
  - name: "total_revenue"
    type: "float"

# Semantic Layer - Conversion Metrics (dbt MetricFlow compatible)
metrics:
  - name: "total_sessions"
    aggregation: "count_distinct"
    expression: "session_id"
    description: "Total number of sessions"

  - name: "unique_visitors"
    aggregation: "count_distinct"
    expression: "user_id"
    description: "Unique visitors in the funnel"

  - name: "conversion_rate_to_cart"
    aggregation: "avg"
    expression: "added_to_cart"
    description: "Conversion rate from visit to cart"
    filters:
      - "visited = 1"

  - name: "conversion_rate_to_purchase"
    aggregation: "avg"
    expression: "purchased"
    description: "Overall conversion rate to purchase"
    filters:
      - "visited = 1"

  - name: "total_revenue"
    aggregation: "sum"
    expression: "total_revenue"
    description: "Total revenue from conversions"
    filters:
      - "purchased = 1"

  - name: "avg_revenue_per_user"
    aggregation: "avg"
    expression: "total_revenue"
    description: "Average revenue per converting user"
    filters:
      - "purchased = 1"

# Semantic Layer - Dimensions
dimensions:
  - name: "analysis_date"
    type: "time"
    expression: "analysis_date"
    description: "Date of the analysis"

  - name: "funnel_stage"
    type: "categorical"
    expression: "CASE
      WHEN purchased = 1 THEN 'purchased'
      WHEN added_to_cart = 1 THEN 'cart'
      WHEN viewed_product = 1 THEN 'product'
      ELSE 'visit'
    END"
    description: "Highest funnel stage reached"

execution:
  timeout_seconds: 600
  dialect: "trino"
