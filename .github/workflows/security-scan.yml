name: Security Scan - Dependency & Code Analysis

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop
  schedule:
    # Run security scans daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      full_scan:
        description: 'Run full security scan including container images'
        required: false
        default: 'false'
        type: boolean

concurrency:
  group: security-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

permissions:
  contents: read
  security-events: write
  actions: read

env:
  REGISTRY: ghcr.io

jobs:
  # Dependency scanning for Kotlin/Gradle
  gradle-dependency-check:
    name: Gradle Dependency Check
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up JDK 21
        uses: actions/setup-java@c5195efecf7bdfc987ee8bae7a71cb8b11521c00 # v4.7.1
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: gradle

      - name: Run OWASP Dependency Check
        continue-on-error: true
        working-directory: project-basecamp-server
        run: ./gradlew dependencyCheckAnalyze --no-daemon
        env:
          GRADLE_OPTS: '-Dorg.gradle.daemon=false'

      - name: Upload Dependency Check results
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: gradle-dependency-check-${{ github.sha }}
          path: project-basecamp-server/build/reports/dependency-check/
          retention-days: 30
          if-no-files-found: ignore

      - name: Output scan summary
        if: always()
        run: |
          echo "### Gradle Dependency Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [[ -f "project-basecamp-server/build/reports/dependency-check/dependency-check-report.html" ]]; then
            echo "Report generated successfully. See artifacts for details." >> $GITHUB_STEP_SUMMARY
          else
            echo "No report generated. Check workflow logs for details." >> $GITHUB_STEP_SUMMARY
          fi

  # Dependency scanning for Python projects
  python-dependency-check:
    name: Python Dependency Check
    runs-on: ubuntu-latest
    timeout-minutes: 15
    strategy:
      fail-fast: false
      matrix:
        project:
          - project-basecamp-parser
          - project-interface-cli
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up Python 3.12
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: '3.12'

      - name: Install uv
        uses: astral-sh/setup-uv@f0ec1fc3b38f5e7cd731bb6ce540c5af426746bb # v6.1.0

      - name: Install dependencies and audit
        working-directory: ${{ matrix.project }}
        run: |
          uv sync --frozen
          uv pip compile pyproject.toml -o requirements.txt
          uv pip install pip-audit
          uv run pip-audit -r requirements.txt --desc --format=json --output=audit-results.json || true

      - name: Upload audit results
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: python-audit-${{ matrix.project }}-${{ github.sha }}
          path: ${{ matrix.project }}/audit-results.json
          retention-days: 30
          if-no-files-found: ignore

      - name: Output scan summary
        if: always()
        run: |
          echo "### Python Dependency Audit - ${{ matrix.project }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [[ -f "${{ matrix.project }}/audit-results.json" ]]; then
            VULN_COUNT=$(cat "${{ matrix.project }}/audit-results.json" | jq 'length' 2>/dev/null || echo "unknown")
            echo "Vulnerabilities found: ${VULN_COUNT}" >> $GITHUB_STEP_SUMMARY
          else
            echo "Audit completed. See artifacts for details." >> $GITHUB_STEP_SUMMARY
          fi

  # NPM dependency scanning
  npm-dependency-check:
    name: NPM Dependency Check
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: 'project-basecamp-ui/package-lock.json'

      - name: Install dependencies
        working-directory: project-basecamp-ui
        run: npm ci

      - name: Run npm audit
        working-directory: project-basecamp-ui
        run: |
          npm audit --json > audit-results.json || true
          npm audit --audit-level=moderate || true

      - name: Upload audit results
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: npm-audit-${{ github.sha }}
          path: project-basecamp-ui/audit-results.json
          retention-days: 30
          if-no-files-found: ignore

      - name: Output scan summary
        if: always()
        run: |
          echo "### NPM Dependency Audit" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [[ -f "project-basecamp-ui/audit-results.json" ]]; then
            VULN_HIGH=$(cat project-basecamp-ui/audit-results.json | jq '.metadata.vulnerabilities.high // 0' 2>/dev/null || echo "0")
            VULN_CRITICAL=$(cat project-basecamp-ui/audit-results.json | jq '.metadata.vulnerabilities.critical // 0' 2>/dev/null || echo "0")
            echo "High: ${VULN_HIGH}, Critical: ${VULN_CRITICAL}" >> $GITHUB_STEP_SUMMARY
          fi

  # CodeQL analysis for code security
  codeql-analysis:
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      security-events: write
      contents: read
    strategy:
      fail-fast: false
      matrix:
        language: ['java-kotlin', 'javascript-typescript', 'python']
        include:
          - language: java-kotlin
            build-command: |
              cd project-basecamp-server && ./gradlew clean build -x test --no-daemon
          - language: javascript-typescript
            build-command: |
              cd project-basecamp-ui && npm ci && npm run build
          - language: python
            build-command: ''
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up JDK 21
        if: matrix.language == 'java-kotlin'
        uses: actions/setup-java@c5195efecf7bdfc987ee8bae7a71cb8b11521c00 # v4.7.1
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Set up Node.js
        if: matrix.language == 'javascript-typescript'
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: 'project-basecamp-ui/package-lock.json'

      - name: Initialize CodeQL
        uses: github/codeql-action/init@fca7ace96b7d713c7035871441bd52efbe39e27e # v3.28.19
        with:
          languages: ${{ matrix.language }}
          queries: security-extended

      - name: Build for analysis
        if: matrix.build-command != ''
        run: ${{ matrix.build-command }}
        continue-on-error: true

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@fca7ace96b7d713c7035871441bd52efbe39e27e # v3.28.19
        with:
          category: "/language:${{ matrix.language }}"

  # Container image scanning with Trivy
  container-image-scan:
    name: Container Image Scan
    runs-on: ubuntu-latest
    timeout-minutes: 45
    if: |
      (github.ref == 'refs/heads/main' && github.event_name == 'push') ||
      github.event_name == 'schedule' ||
      github.event.inputs.full_scan == 'true'
    permissions:
      contents: read
      security-events: write
    strategy:
      fail-fast: false
      matrix:
        project:
          - name: basecamp-server
            path: project-basecamp-server
          - name: basecamp-parser
            path: project-basecamp-parser
          - name: basecamp-ui
            path: project-basecamp-ui
          - name: interface-cli
            path: project-interface-cli
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Check Dockerfile exists
        id: dockerfile-check
        run: |
          if [[ -f "${{ matrix.project.path }}/Dockerfile" ]]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Set up Docker Buildx
        if: steps.dockerfile-check.outputs.exists == 'true'
        uses: docker/setup-buildx-action@b5ca514318bd6ebac0fb2aedd5d36ec1b5c232a2 # v3.10.0

      - name: Build image for scanning
        if: steps.dockerfile-check.outputs.exists == 'true'
        uses: docker/build-push-action@14487ce63c7a62a4a324b0bfb37086795e31c6c1 # v6.16.0
        with:
          context: ./${{ matrix.project.path }}
          file: ./${{ matrix.project.path }}/Dockerfile
          push: false
          load: true
          tags: ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ matrix.project.name }}:scan
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Run Trivy vulnerability scanner
        if: steps.dockerfile-check.outputs.exists == 'true'
        uses: aquasecurity/trivy-action@6c175e9c4083a92bbca2f9724c8a5e33bc2d97a5 # v0.30.0
        with:
          image-ref: ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ matrix.project.name }}:scan
          format: 'sarif'
          output: '${{ matrix.project.name }}-trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
          ignore-unfixed: true
        continue-on-error: true

      - name: Upload Trivy scan results to GitHub Security
        if: steps.dockerfile-check.outputs.exists == 'true'
        uses: github/codeql-action/upload-sarif@fca7ace96b7d713c7035871441bd52efbe39e27e # v3.28.19
        with:
          sarif_file: '${{ matrix.project.name }}-trivy-results.sarif'
          category: 'trivy-${{ matrix.project.name }}'
        continue-on-error: true

      - name: Generate Trivy table report
        if: steps.dockerfile-check.outputs.exists == 'true'
        uses: aquasecurity/trivy-action@6c175e9c4083a92bbca2f9724c8a5e33bc2d97a5 # v0.30.0
        with:
          image-ref: ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ matrix.project.name }}:scan
          format: 'table'
          severity: 'CRITICAL,HIGH,MEDIUM'
          ignore-unfixed: true
        continue-on-error: true

  # License compliance check
  license-check:
    name: License Compliance Check
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: 'project-basecamp-ui/package-lock.json'

      - name: Check licenses - UI
        working-directory: project-basecamp-ui
        run: |
          npm ci
          npx license-checker --json --out license-report.json || true
          npx license-checker --summary || true

      - name: Check for problematic licenses
        working-directory: project-basecamp-ui
        run: |
          echo "### License Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          npx license-checker --summary >> $GITHUB_STEP_SUMMARY || true
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Checking for GPL licenses (may require special handling):" >> $GITHUB_STEP_SUMMARY
          npx license-checker --onlyAllow 'MIT;ISC;Apache-2.0;BSD-2-Clause;BSD-3-Clause;0BSD;CC0-1.0;Unlicense;CC-BY-4.0;CC-BY-3.0;Python-2.0;BlueOak-1.0.0' 2>&1 | head -20 >> $GITHUB_STEP_SUMMARY || true

      - name: Upload license report
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: license-compliance-report-${{ github.sha }}
          path: project-basecamp-ui/license-report.json
          retention-days: 30
          if-no-files-found: ignore

  # Security scan summary
  security-summary:
    name: Security Scan Summary
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs:
      - gradle-dependency-check
      - python-dependency-check
      - npm-dependency-check
      - codeql-analysis
      - license-check
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "# Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Gradle Dependency Check | ${{ needs.gradle-dependency-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Python Dependency Check | ${{ needs.python-dependency-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| NPM Dependency Check | ${{ needs.npm-dependency-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| CodeQL Analysis | ${{ needs.codeql-analysis.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| License Check | ${{ needs.license-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Run ID:** ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
